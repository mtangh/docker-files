#!/bin/bash
set -ux -o errtrace -o functrace -o pipefail

work_dir=$(pwd)

: "Print node and npm version" && {
 
  node -v &&
  npm -v && {
    [ -x "$(type -P npm-g)" ] ||
    ln -sf "$(type -P npm)"{,-g}
  }

} &&
: "Install global node packages" && {

  nodejsmods=""

  if [ -s "./node_modules.txt" ]
  then nodejsmods=$(eval echo $(cat ./node_modules.txt))
  else : noop
  fi || :

  if [ -n "${nodejsmods:-}" ]
  then npm-g install ${nodejsmods}
  else echo "node_modules.txt is missing."
  fi || exit 1

} &&
: "Install using package.json" && {

  if [ -e "./package.json" ]
  then npm-g install
  else echo "package.json is missing."
  fi || exit 1

} &&
: "NPM Cache cleanup" && {

  npm-g cache clean --force || :

} &&
: "Done."

exit $?
